# Сервис управления рассылками
Сервис управления рассылками API администрирования и получения статистики.

## Overview
* Рассылка осуществляется через внешний сервис  [https://probe.fbrq.cloud/docs](https://probe.fbrq.cloud/docs) 
* Доступна админ-панель для создания, редактирования и удаления клиентов и рассылок и просмотра статистики
* Раз в сутки сервис отправляет статистику по отправленным рассылкам на указанную почту
***
## Сущности

**Клиент**
* Номер телефона в формате в формате 7XXXXXXXXXX (X - цифра от 0 до 9)
* Код мобильного оператора (3 цифры)
* Тег - произвольная метка, не обязательна
* Часовой пояс клиента

**Сообщение**
* Дата и время отправки сообщения
* Статус отправки (отправлено, ожидает отправки, отменено)
* Кому отправлено
* В рамках какой рассылки отправлено


**Рассылка**

* Дата и время запуска рассылки
* Дата и время окончания рассылки
* Фильтр свойств клиентов, которым должна быть произведена рассылка. Фильтрация по тегу и коду оператора
* Текст сообщения для отправки клиенту

**Статистика**
* Общая: была ли рассылка запущена, сколько сообщений должно было быть отправлено, сколько было отправлено
* Детализированная: список всех сообщений с их статусами по каждой рассылке

***


## Начало работы
* Установите Redis
```
sudo apt-get update
sudo apt-get install redis
``` 

* Установите необходимую вам СУБД
* Клонируйте репозиторий
```
git clone https://gitlab.com/riveriswild/mailing_api.git
``` 
* Заполните файл .env необходимыми данными
* Активируйте виртуальное окружение
```
python -m venv venv  
source venv/bin/activate
```
* Установите зависимости
```
pip install -r requirements.txt
``` 
* Создайте и примените миграции
```
python manage.py makemigrations
python manage.py migrate
```
* Создайте суперпользователя

* Запустите Celery
```
celery -A notifications_api worker --beat -l INFO
```
* В новом терминале запустите сервер
```
python manage.py runserver
```

##  Установка с помошью Docker
* Установите Docker
* Клонируйте репозиторий
```
git clone https://gitlab.com/riveriswild/mailing_api.git
``` 
* Заполните файл .env необходимыми данными
* Запуск контейнеров
```
sudo docker-compose up --build
``` 
***


### API
`mailing/api/Clients`
* GET - информация по всем клиентам
* POST - создание нового клиента

`mailing/api/clients/{id}/`
* GET - получение данных определенного клиента по id
* PUT - редактирование данных клиента по id
* DELETE - удаление клиента

`mailing/api/mailings/`
* GET - информация по всем рассылкам
* POST - создание новой рассылки

`mailing/api/mailings/{id}/`
* GET - информация по рассылке с указанным id
* PUT - изменение данной рассылки
* DELETE - удаление данной рассылки

`mailing/api/statistics/`

* GET - сводная статистика по рассылкам

`mailing/api/statistics/{id}/`
* GET - статистика по конкретной рассылке по id

***
**Выполненные дополнительные задачи**
* Подготовить docker-compose для запуска всех сервисов проекта одной командой
* Сделать так, чтобы по адресу /docs/ открывалась страница со Swagger UI и в нём отображалось описание разработанного API. Пример: https://petstore.swagger.io
* Реализовать дополнительный сервис, который раз в сутки отправляет статистику по обработанным рассылкам на email
* Удаленный сервис может быть недоступен, долго отвечать на запросы или выдавать некорректные ответы. Необходимо организовать обработку ошибок и откладывание запросов при неуспехе для последующей повторной отправки. Задержки в работе внешнего сервиса никак не должны оказывать влияние на работу сервиса рассылок.
* *Реализовать дополнительную бизнес-логику: добавить в сущность "рассылка" поле "временной интервал", в котором можно задать промежуток времени, в котором клиентам можно отправлять сообщения с учётом их локального времени. Не отправлять клиенту сообщение, если его локальное время не входит в указанный интервал.* **Попытка была, успех сомнительный, но можно еще покопаться**



